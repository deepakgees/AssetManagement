generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Account {
  id               Int                 @id @default(autoincrement())
  name             String
  apiKey           String?
  lastSync         DateTime?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  userId           String?
  password         String?
  apiSecret        String?
  family           String?
  accessToken      String?
  refreshToken     String?
  description      String?
  isActive         Boolean             @default(true)
  requestToken     String?
  totpSecret       String?
  dividendRecords  DividendRecord[]
  fundTransactions FundTransaction[]
  holdings         Holding[]
  margins          Margin[]
  pnlRecords       PnLRecord[]
  snapshots        PortfolioSnapshot[]
  positions        Position[]

  @@map("accounts")
}

model Holding {
  id                 Int      @id @default(autoincrement())
  tradingSymbol      String
  quantity           Int
  averagePrice       Float
  lastPrice          Float
  marketValue        Float
  pnl                Float
  pnlPercentage      Float
  exchange           String
  sector             String?
  accountId          Int
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  instrumentToken    Int?
  isin               String?
  product            String?
  collateralQuantity Int?
  collateralType     String?
  t1Quantity         Int?
  realisedQuantity   Int?
  account            Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@map("holdings")
}

model Position {
  id            Int      @id @default(autoincrement())
  tradingSymbol String
  quantity      Int
  averagePrice  Float
  lastPrice     Float
  marketValue   Float
  pnl           Float
  pnlPercentage Float
  exchange      String
  product       String
  side          String
  accountId     Int
  marginBlocked Float? // Margin blocked for this position (calculated from Kite Connect API)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  account       Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@map("positions")
}

model PortfolioSnapshot {
  id                 Int      @id @default(autoincrement())
  totalValue         Float
  totalPnL           Float
  totalPnLPercentage Float
  cashBalance        Float
  marginUsed         Float
  availableMargin    Float
  accountId          Int
  createdAt          DateTime @default(now())
  account            Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@map("portfolio_snapshots")
}

model Margin {
  id               Int      @id @default(autoincrement())
  accountId        Int
  segment          String
  enabled          Boolean
  net              Float
  debits           Float
  payout           Float
  liquidCollateral Float
  stockCollateral  Float
  span             Float
  exposure         Float
  additional       Float
  delivery         Float
  optionPremium    Float
  holdingSales     Float
  turnover         Float
  equity           Float
  m2mRealised      Float
  m2mUnrealised    Float
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  account          Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@map("margins")
}

model PnLRecord {
  id                         Int       @id @default(autoincrement())
  instrumentType             String
  symbol                     String?
  isin                       String?
  entryDate                  DateTime?
  exitDate                   DateTime?
  quantity                   Float?
  buyValue                   Float?
  sellValue                  Float?
  profit                     Float?
  periodOfHolding            String?
  fairMarketValue            Float?
  taxableProfit              Float?
  turnover                   Float?
  brokerage                  Float?
  exchangeTransactionCharges Float?
  ipft                       Float?
  sebiCharges                Float?
  cgst                       Float?
  sgst                       Float?
  igst                       Float?
  stampDuty                  Float?
  stt                        Float?
  createdAt                  DateTime  @default(now())
  updatedAt                  DateTime  @updatedAt
  accountId                  Int
  account                    Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@map("pnl_records")
}

model DividendRecord {
  id                Int       @id @default(autoincrement())
  symbol            String?
  isin              String?
  exDate            DateTime?
  quantity          Float?
  dividendPerShare  Float?
  netDividendAmount Float?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  accountId         Int
  account           Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([accountId, symbol, isin, exDate, quantity, dividendPerShare, netDividendAmount], name: "unique_dividend_record")
  @@map("dividend_records")
}

model FundTransaction {
  id              Int      @id @default(autoincrement())
  accountId       Int
  transactionDate DateTime
  amount          Float
  type            String
  description     String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  account         Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@map("fund_transactions")
}

model HistoricalPriceCommodities {
  id            Int      @id @default(autoincrement())
  symbol        String
  closingPrice  Float
  percentChange Float?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  year          Int
  month         Int

  @@unique([symbol, year, month], name: "unique_commodity_symbol_year_month")
  @@map("historical_price_commodities")
}

model HistoricalPriceEquity {
  id            Int      @id @default(autoincrement())
  symbol        String
  year          Int
  month         Int
  closingPrice  Float
  percentChange Float?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([symbol, year, month], name: "unique_equity_symbol_year_month")
  @@map("historical_price_equity")
}

model SymbolMargin {
  id           Int      @id @default(autoincrement())
  symbol       String
  margin       Float
  safetyMargin Float?   @map("safety_margin")
  symbolType   String   @default("equity") @map("symbol_type")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@unique([symbol, symbolType], name: "unique_symbol_margin_symbol_type", map: "unique_symbol_margin_symbol_type")
  @@index([createdAt], map: "idx_symbol_margins_created_at")
  @@index([symbol], map: "idx_symbol_margins_symbol")
  @@index([symbolType], map: "idx_symbol_margins_symbol_type")
  @@map("symbol_margins")
}

model safety_margins {
  id           Int      @id @default(autoincrement())
  symbol       String
  safetyMargin Float
  type         String   @default("commodity")
  createdAt    DateTime @default(now())
  updatedAt    DateTime

  @@unique([symbol, type], map: "unique_safety_margin_symbol_type")
}

model symbol_and_margins {
  id           Int      @id @default(autoincrement())
  symbolPrefix String   @unique
  margin       Float
  symbolType   String   @default("equity")
  createdAt    DateTime @default(now())
  updatedAt    DateTime
}
